name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

permissions:
  contents: write

jobs:
  release:
    name: Bump Version & Publish
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.new }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-09-14

      - name: Determine bump type
        id: bump
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "type=${{ inputs.bump }}" >> $GITHUB_OUTPUT
          else
            echo "type=patch" >> $GITHUB_OUTPUT
          fi

      - name: Bump versions in all crates
        id: version
        run: |
          BUMP_TYPE=${{ steps.bump.outputs.type }}

          CRATES=(
            "crates/common"
            "crates/storage"
            "crates/ir"
            "crates/optimizer"
            "crates/parser"
            "crates/functions"
            "crates/executor"
            "."
            "crates/test-utils"
            "crates/cli"
          )

          CURRENT=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case $BUMP_TYPE in
            major) NEW_VERSION="$((MAJOR + 1)).0.0" ;;
            minor) NEW_VERSION="${MAJOR}.$((MINOR + 1)).0" ;;
            patch) NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))" ;;
          esac

          echo "Bumping from $CURRENT to $NEW_VERSION"
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT

          for crate in "${CRATES[@]}"; do
            if [ -f "$crate/Cargo.toml" ]; then
              echo "Updating $crate/Cargo.toml"
              sed -i "s/^version = \"$CURRENT\"/version = \"$NEW_VERSION\"/" "$crate/Cargo.toml"
              sed -i "s/yachtsql-common = { version = \"$CURRENT\"/yachtsql-common = { version = \"$NEW_VERSION\"/g" "$crate/Cargo.toml"
              sed -i "s/yachtsql-storage = { version = \"$CURRENT\"/yachtsql-storage = { version = \"$NEW_VERSION\"/g" "$crate/Cargo.toml"
              sed -i "s/yachtsql-ir = { version = \"$CURRENT\"/yachtsql-ir = { version = \"$NEW_VERSION\"/g" "$crate/Cargo.toml"
              sed -i "s/yachtsql-optimizer = { version = \"$CURRENT\"/yachtsql-optimizer = { version = \"$NEW_VERSION\"/g" "$crate/Cargo.toml"
              sed -i "s/yachtsql-parser = { version = \"$CURRENT\"/yachtsql-parser = { version = \"$NEW_VERSION\"/g" "$crate/Cargo.toml"
              sed -i "s/yachtsql-functions = { version = \"$CURRENT\"/yachtsql-functions = { version = \"$NEW_VERSION\"/g" "$crate/Cargo.toml"
              sed -i "s/yachtsql-executor = { version = \"$CURRENT\"/yachtsql-executor = { version = \"$NEW_VERSION\"/g" "$crate/Cargo.toml"
              sed -i "s/yachtsql-test-utils = { version = \"$CURRENT\"/yachtsql-test-utils = { version = \"$NEW_VERSION\"/g" "$crate/Cargo.toml"
              sed -i "s/yachtsql = { version = \"$CURRENT\"/yachtsql = { version = \"$NEW_VERSION\"/g" "$crate/Cargo.toml"
            fi
          done

      - name: Verify build
        run: cargo build --release

      - name: Commit version bump
        run: |
          git add -A
          git commit -m "chore: bump version to ${{ steps.version.outputs.new }}" || echo "No changes to commit"
          git push

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          CRATES=(
            "crates/common:yachtsql-common"
            "crates/storage:yachtsql-storage"
            "crates/ir:yachtsql-ir"
            "crates/optimizer:yachtsql-optimizer"
            "crates/parser:yachtsql-parser"
            "crates/functions:yachtsql-functions"
            "crates/executor:yachtsql-executor"
            ".:yachtsql"
            "crates/test-utils:yachtsql-test-utils"
            "crates/cli:yachtsql-cli"
          )

          for entry in "${CRATES[@]}"; do
            IFS=':' read -r path name <<< "$entry"
            echo "Publishing $name from $path..."

            MAX_RETRIES=3
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if cargo publish --manifest-path "$path/Cargo.toml" --no-verify 2>&1; then
                echo "$name published successfully"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "Publish failed, waiting 60s before retry $RETRY_COUNT..."
                  sleep 60
                else
                  echo "Failed to publish $name after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done

            echo "Waiting for $name to be available..."
            sleep 30
          done

      - name: Create release tag
        run: |
          git tag "v${{ steps.version.outputs.new }}"
          git push origin "v${{ steps.version.outputs.new }}"

  build-binaries:
    name: Build Binary (${{ matrix.target }})
    needs: release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-pc-windows-msvc
            os: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: v${{ needs.release.outputs.version }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-09-14
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          if [ "${{ matrix.target }}" == "x86_64-unknown-linux-musl" ]; then
            sudo apt-get install -y musl-tools
          elif [ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu
          fi

      - name: Build binary
        run: cargo build --release --target ${{ matrix.target }} --package yachtsql-cli

      - name: Package binary (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p yachtsql-${{ matrix.target }}
          cp target/${{ matrix.target }}/release/yachtsql yachtsql-${{ matrix.target }}/
          tar -czvf yachtsql-${{ matrix.target }}.tar.gz yachtsql-${{ matrix.target }}

      - name: Package binary (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir yachtsql-${{ matrix.target }}
          cp target/${{ matrix.target }}/release/yachtsql.exe yachtsql-${{ matrix.target }}/
          Compress-Archive -Path yachtsql-${{ matrix.target }} -DestinationPath yachtsql-${{ matrix.target }}.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: yachtsql-${{ matrix.target }}
          path: yachtsql-${{ matrix.target }}.*

  create-release:
    name: Create GitHub Release
    needs: [release, build-binaries]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect binaries
        run: |
          mkdir release-files
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-files/ \;
          ls -la release-files/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.release.outputs.version }}
          name: Release v${{ needs.release.outputs.version }}
          generate_release_notes: true
          files: release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
